---

- 

  hosts: all
  become: yes
  become_method: sudo 
  become_user: root 
  connection: ssh
  tasks:
    - name: update ubuntu system 
      apt:
        update_cache=yes
    - name: upload the kernal module
      modprobe:
        name: "{{item}}"
        state: present 
      with_items:
        - overlay
        - br_netfilter
    
    - name: turn sysctl parameters in /proc 
      sysctl:
        name: "{{item}}"
        value: '1'
        sysctl_set: yes
        state: present 
      with_items:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables
        - net.ipv4.ip_forward    
    - name: install dependency and configure 
      shell: |
             sudo apt-get update && sudo apt-get install -y apt-transport-https curl
             curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-get add -
    - name: create kubernetes repo file
      file:
        path: "/etc/apt/sources.list.d/kubernetes.list"
        state: touch
    - name: add k8s source 
      blockinfile:
        path: "/etc/apt/sources.list.d/kubernetes.list"
        block: |
              deb https://apt.kubernetes.io/ kubernetes-xenial main
    - name: install kuerbetes
      shell:
        sudo apt-get update
        sudo apt-get install -y kubelet kubeadm kubectl
        sudo apt-mark hold kubelet kubeadm kubectl

    - name: install container d as platform
      shell:
        sudo apt-get update && sudo apt-get install -y containerd
        sudo mkdir -p /etc/containerd 
        sudo containerd config default |sudo tee /etc/containerd/config.toml
        sudo systemctl restart containerd
          
     